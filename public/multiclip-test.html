<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MultiClip – API Quick Tester</title>
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb; --brand:#f97316; --input:#0b1220; }
    html,body{margin:0;height:100%;background:linear-gradient(180deg,#0b1220,#0f172a);}
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Apple SD Gothic Neo",sans-serif;}
    .wrap{max-width:880px;margin:64px auto;padding:0 16px;}
    .card{background:rgba(17,24,39,.7);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:24px;backdrop-filter:blur(8px);box-shadow:0 10px 30px rgba(0,0,0,.25);}
    h1{color:var(--text);font-weight:800;margin:0 0 18px 0;font-size:20px}
    .row{display:flex;gap:8px;align-items:center}
    .row>input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0b1220;color:var(--text);outline:none}
    select,button{height:42px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#0b1220;color:var(--text);padding:0 12px}
    .btn{background:var(--brand);color:#111827;font-weight:700;border:none;cursor:pointer;padding:0 18px}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:14px 0}
    textarea{width:100%;height:120px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0b1220;color:var(--text);padding:12px;resize:vertical}
    .log{height:120px;white-space:pre-wrap;overflow:auto;background:#0b1220;color:var(--muted);border-radius:12px;border:1px solid rgba(255,255,255,.08);padding:12px}
    .footer{color:#7e8696;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>MultiClip – <span style="opacity:.85">API Quick Tester</span></h1>
      <div class="row">
        <input id="url" placeholder="다운로드할 링크 붙여넣기 (YouTube/Shorts 등)" />
        <select id="quality">
          <option>720p</option><option selected>1080p</option><option>4K</option>
        </select>
        <button id="btn-parse">분석</button>
      </div>
      <button id="btn-download" class="btn" style="width:100%;margin-top:10px">다운로드</button>

      <div class="cols">
        <textarea id="out-parse" readonly placeholder="1) Parse 결과"></textarea>
        <textarea id="out-job" readonly placeholder="2) Job 상태"></textarea>
      </div>
      <div id="log" class="log">–</div>
      <div class="footer">Tip: 무료 인스턴스는 첫 요청 시 웜업으로 수십 초 지연될 수 있습니다.</div>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const log = (s)=>{ const el=$("#log"); el.textContent = (el.textContent==="–"?"":el.textContent+"\n")+`[${new Date().toTimeString().slice(0,8)}] ${s}`; el.scrollTop=el.scrollHeight; };
const api = p => p; // 같은 오리진에 배포되어 있으므로 상대경로 그대로

let latest = { platform:null, resourceId:null, jobId:null, downloadUrl:null };

$("#btn-parse").onclick = async ()=>{
  const url = $("#url").value.trim();
  if(!url){ alert("URL을 입력하세요"); return; }
  log("parse 요청 중…");
  try{
    const r = await fetch(api("/api/parse"), { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify({ url }) });
    const j = await r.json();
    if(!r.ok) throw new Error(j?.error||j?.message||r.statusText);
    latest.platform = j.platform; latest.resourceId = j.resourceId;
    $("#out-parse").value = JSON.stringify(j, null, 2);
    log("parse 완료.");
  }catch(e){ log("parse 오류: "+e.message); alert("Parse 실패: "+e.message); }
};

$("#btn-download").onclick = async ()=>{
  if(!latest.platform){ alert("먼저 [분석]을 눌러 주세요."); return; }
  const quality = $("#quality").value;
  log("download 요청 중…");
  try{
    // 1) 잡 생성
    const r1 = await fetch(api("/api/download"), { method:"POST", headers:{ "content-type":"application/json" },
      body: JSON.stringify({ platform: latest.platform, resourceId: latest.resourceId, url: $("#url").value.trim(), quality, type:"video" })
    });
    const j1 = await r1.json();
    if(!r1.ok) throw new Error(j1?.error||j1?.message||r1.statusText);
    latest.jobId = j1.jobId;
    log(`download enqueued: ${j1.jobId}`);

    // 2) 폴링
    let done=false, tries=0;
    while(!done && tries<60){
      await new Promise(r=>setTimeout(r, 1000));
      const r2 = await fetch(api(`/api/download/status?jobId=${encodeURIComponent(latest.jobId)}`));
      const j2 = await r2.json();
      $("#out-job").value = JSON.stringify(j2, null, 2);
      if(j2.status==="done" && j2.downloadUrl){
        latest.downloadUrl = j2.downloadUrl;
        done = true;
      }else if(j2.status==="error"){
        throw new Error(j2.error||"unknown");
      }
      tries++;
    }

    if(!latest.downloadUrl) throw new Error("timeout");

    // 3) **프록시 없이 직접 다운로드** (CORS 비의존)
    log("완료! 다운로드 링크 열기…");
    window.open(latest.downloadUrl, "_blank");   // 새 탭으로 열기 (또는 location.href = …)
  }catch(e){
    log("오류: "+e.message);
    alert("작업 오류: "+e.message);
  }
};
</script>
</body>
</html>
